version: '3.8'

services:
  anomaly-detection:
    build: .
    container_name: anomaly_detection_app
    ports:
      - "8000:8000"  # FastAPI
      - "8501:8501"  # Streamlit
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./best_autoencoder.pth:/app/best_autoencoder.pth
      - ./best_isolation_forest.pkl:/app/best_isolation_forest.pkl
    environment:
      - PYTHONPATH=/app/src
    command: ./run.sh
    restart: unless-stopped

  # Training service (optional, for running training jobs)
  anomaly-training:
    build: .
    container_name: anomaly_detection_training
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./best_autoencoder.pth:/app/best_autoencoder.pth
      - ./best_isolation_forest.pkl:/app/best_isolation_forest.pkl
    environment:
      - PYTHONPATH=/app/src
    command: python src/train.py
    profiles: ["training"]  # Only start with --profile training

  # API only service
  anomaly-api:
    build: .
    container_name: anomaly_detection_api
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./best_autoencoder.pth:/app/best_autoencoder.pth
      - ./best_isolation_forest.pkl:/app/best_isolation_forest.pkl
    environment:
      - PYTHONPATH=/app/src
    command: uvicorn api.app:app --host 0.0.0.0 --port 8000
    profiles: ["api"]  # Only start with --profile api
    restart: unless-stopped

  # Demo only service
  anomaly-demo:
    build: .
    container_name: anomaly_detection_demo
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./best_autoencoder.pth:/app/best_autoencoder.pth
      - ./best_isolation_forest.pkl:/app/best_isolation_forest.pkl
    environment:
      - PYTHONPATH=/app/src
    command: streamlit run demo/app.py --server.address 0.0.0.0 --server.port 8501
    profiles: ["demo"]  # Only start with --profile demo
    restart: unless-stopped
